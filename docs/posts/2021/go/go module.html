<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:title" content="Go 模块化 · 自然醒的博客"/><meta data-react-helmet="true" property="og:description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary"/>
<title data-react-helmet="true">Go 模块化 · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/docs/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/docs/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/docs/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/docs/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/docs/">自然醒的博客</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/docs/assets/czs-close-l.svg&quot;)"></a><h1><a href="/docs/">自然醒的博客</a></h1><p class="description">前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/docs/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/docs/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/docs/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/docs/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/docs/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/docs/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/docs/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/docs/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/docs/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/docs/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/docs/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/docs/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%89%8D%E8%A8%80">前言</a></li><li><a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">环境变量</a></li><li><a href="#gopath">GOPATH</a></li><li><a href="#go-vendor">Go Vendor</a><ol><li><a href="#%E9%85%8D%E7%BD%AE%E5%BC%80%E5%85%B3">配置开关</a></li></ol></li><li><a href="#go-modules">Go Modules</a><ol><li><a href="#%E5%AF%BC%E5%85%A5%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%9C%AC%E5%9C%B0%E6%A8%A1%E5%9D%97">导入与导入本地模块</a></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ol></nav></aside><section class="main"><h1>Go 模块化</h1><div class="main_post_meta"><time dateTime="2021/04/05">2021-04-05</time> · <!-- -->shenfq</div><article><h2 id="%E5%89%8D%E8%A8%80">前言<a class="anchor" href="#%E5%89%8D%E8%A8%80">§</a></h2>
<p>在很久很久以前，就 push 自己学过 go 语言，但是之前只是看了一下基础语法就放弃了，实在是工作当中没有应用场景。最近发现基于 go 写的 esbuild 异军突起，想要深入研究下它的奥秘，发现看不懂。于是，打算先从 go 开始学一遍，等我把 go 学好了，再去研究 esbuild。所以，最近的几篇文章都会写 go 的一些学习心得，今天的文章就从 go 语言的模块化开始。</p>
<p><img src="https://file.shenfq.com/pic/20210405193808.png" alt=""></p>
<h2 id="%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">环境变量<a class="anchor" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">§</a></h2>
<p>学习 go 语言的第一步，当然是安装以及环境变量。由于我是 macos，直接运行 <code>brew install go</code> 就能安装成功，也可以在<a href="https://golang.google.cn/">官网（https://golang.google.cn/）</a>下载对应的二进制包。</p>
<p>安装成功后，需要配置下面几个环境变量：</p>
<ul>
<li>GOROOT：go 语言的安装路径；</li>
<li>GOBIN：go 语言的可执行文件路径，一般为 <code>&quot;$GOROOT/bin&quot;</code>；</li>
<li>GOPATH：工作目录，可设置多个，每个项目都可以设置一个单独的GOPATH；</li>
</ul>
<h2 id="gopath">GOPATH<a class="anchor" href="#gopath">§</a></h2>
<p>在 GoLand（go 语言最强IDE） 中，我们可以在 <code>Preferences</code> 中设置多个 GOPATH，而且将 GOPATH 分为全局和局部的。</p>
<p><img src="https://file.shenfq.com/pic/20210402194612.png" alt=""></p>
<p>GOPATH 最早出现的意义是用来进行模块管理，每个 GOPATH 中会有三个目录：</p>
<ul>
<li>src：用来存放源代码；</li>
<li>pkg：用来存放编译后的 <code>.a(archive)</code> 静态库文件；</li>
<li>bin：用来存放编译后可直接运行的二进制文件；</li>
</ul>
<p><img src="https://file.shenfq.com/pic/20210402194916.png" alt=""></p>
<p>一般设置为工作目录的 src 文件夹需要手动创建，其他两个目录都是编译后自动生成的。</p>
<p>接下来，我们新建了一个目录 <code>~/Code/goland/go-story</code>，并将该目录设置为工作目录。</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPATH</span><span class="token operator">=</span><span class="token string">"~/Code/goland/go-story"</span>
</code></pre>
<p>然后在当前目录新建一个 <code>src</code> 文件夹，并新建一个 <code>hello</code> 目录，在 <code>hello</code> 目录新建 <code>main.go</code> 文件。</p>
<p><img src="https://file.shenfq.com/pic/20210405141212.png" alt=""></p>
<p>在 <code>hello/main.go</code> 文件中，写入如下代码：</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"flag"</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> name <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"everyone"</span><span class="token punctuation">,</span> <span class="token string">"The greeting object."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解析命令行参数</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"\nHello %s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>flag 库是 go 内置的模块，类似于 node 的 <a href="https://www.npmjs.com/package/commander">commander</a> 库，运行后结果如下所示：</p>
<p><img src="https://file.shenfq.com/pic/20210405143954.png" alt=""></p>
<p>下面我们引入一个能够让命令行输出色彩更加丰富的库：<a href="https://github.com/TreyBastian/colourize">colourize</a>，类似于 node 中的 <a href="https://www.npmjs.com/package/chalk">chalk</a>。通过下面这个命令来安装依赖：</p>
<pre class="language-bash"><code class="language-bash">go get github.com/TreyBastian/colourize 
</code></pre>
<p>运行之后，我们可以看到在工作区自动创建了一个 <code>pkg</code> 目录，目录下新生成的是 <code>colourize</code> 库文件，同时 src 目录也新建了一个 <code>github.com</code> 目录，用来放 <code>colourize</code> 的源码。</p>
<p><img src="https://file.shenfq.com/pic/20210405141929.png" alt=""></p>
<p><code>go get</code> 命令可以简单理解为 <code>npm install</code>。接下来就能在 <code>hello/main.go</code> 中引入依赖。</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"flag"</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/TreyBastian/colourize"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> name <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"everyone"</span><span class="token punctuation">,</span> <span class="token string">"The greeting object."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>colourize<span class="token punctuation">.</span><span class="token function">Colourize</span><span class="token punctuation">(</span><span class="token string">"\nHello %s\n"</span><span class="token punctuation">,</span> colourize<span class="token punctuation">.</span>Blue<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">hello</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>运行 <code>hello/main.go</code> 可以看到命令行输出了蓝色的文字。</p>
<p><img src="https://file.shenfq.com/pic/20210405142320.png" alt=""></p>
<p>默认情况下，go 依赖的加载机制为：</p>
<ul>
<li><code>$GOROOT</code> 下的 <code>src</code> 目录</li>
<li><code>$GOPATH</code> 下的 <code>src</code> 目录</li>
</ul>
<h2 id="go-vendor">Go Vendor<a class="anchor" href="#go-vendor">§</a></h2>
<p>前面这种方式，有个很麻烦的问题，就是没有办法进行很好的版本管理，而且多个依赖分散在 <code>$GOPATH/src</code> 目录下，可能会出现很多很麻烦的问题。</p>
<p>例如，我现在在 <code>GOPATH</code> 下有两个项目：<code>go-blog</code>、<code>go-stroy</code>，这两个项目分别有不同的依赖，分散在 <code>github.com</code> 目录，这个时候到底要不要将整个 <code>github.com</code> 目录添加到版本库呢？</p>
<p><img src="https://file.shenfq.com/pic/20210405150429.png" alt=""></p>
<p>go 在 1.5 版本的时候，引入了 vendor 机制，在每个项目目录下可以通过 <code>vendor</code> 目录存放依赖，这类似于 node 中的 <code>node_modules</code> 目录。</p>
<p><img src="https://file.shenfq.com/pic/20210405150802.png" alt=""></p>
<p>使用 <code>go vendor</code> 需要先安装 <code>govendor</code> 模块。</p>
<pre class="language-bash"><code class="language-bash">go get govendor
</code></pre>
<p>然后在项目目录运行如下命令。</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/Code/gland/go-story/src/hello
govendor init
govendor <span class="token function">add</span> github.com/TreyBastian/colourize
</code></pre>
<p>可以看到，<code>hello</code> 项目下新生成了一个 <code>vendor</code> 目录，而且 <code>colourize</code> 也被拷贝到了该目录下。</p>
<p><img src="https://file.shenfq.com/pic/20210405150717.png" alt=""></p>
<p>而且 <code>govendor</code> 会新建一个 <code>vendor.json</code> 文件，用来进行依赖项的管理。</p>
<p><img src="https://file.shenfq.com/pic/20210405151449.png" alt=""></p>
<p>有了 <code>go vendor</code> 之后，依赖项的加载顺序如下：</p>
<ul>
<li>项目目录下的 <code>vendor</code> 目录</li>
<li>项目目录上一级的 <code>vendor</code> 目录</li>
<li>不断向上冒泡 ……（PS. 类似于 <code>node_modules</code>）</li>
<li><code>$GOPATH</code> 下的 <code>vendor</code> 目录</li>
<li><code>$GOROOT</code> 下的 <code>src</code> 目录</li>
<li><code>$GOPATH</code> 下的 <code>src</code> 目录</li>
</ul>
<h3 id="%E9%85%8D%E7%BD%AE%E5%BC%80%E5%85%B3">配置开关<a class="anchor" href="#%E9%85%8D%E7%BD%AE%E5%BC%80%E5%85%B3">§</a></h3>
<p>有一点需要注意，在 go 1.5 版本下，<code>go vendor</code> 并不是默认开启的，需要手动配置环境变量：</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">GO15VENDOREXPERIMENT</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre>
<p>在 go 1.6 版本中，<code>go vendor</code> 已经改为默认开启。</p>
<h2 id="go-modules">Go Modules<a class="anchor" href="#go-modules">§</a></h2>
<p>虽然 1.5 版本推出了 <code>go vendor</code>，但是没有解决根本问题，只是依赖的查找上支持到了 <code>vendor</code> 目录，<code>vendor</code> 目录还是需要一些第三方的库（<code>govendor</code>、<code>godep</code>、<code>glide</code>）进行管理，而且对于 <code>GOPATH</code> 环境变量依然有所依赖。</p>
<p>官方为了解决这些问题，终于在 1.11 版本中，实验性的内置了其模块管理的能力（1.12 版本正式开启）：<code>go mod</code>。</p>
<p>使用 <code>go mod</code> 的时候，我们无需 <code>GOPATH</code>，所以我们需要把之前配置的 <code>GOPATH</code> 清理掉，调整下目录结构，将 <code>go-story/hello/main.go</code> 直接移动到 <code>go-story/main.go</code>，然后将 <code>src</code>、<code>pkg</code> 目录删除。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 初始化 go modules</span>
go mod init <span class="token punctuation">[</span>pkg-name<span class="token punctuation">]</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/20210405172840.png" alt=""></p>
<p>此时，会在目录下生成一个 <code>go.mod</code> 文件。</p>
<p><img src="https://file.shenfq.com/pic/20210405172955.png" alt=""></p>
<p>查看其内容，发现里面会声明 go 的版本号，以及当前模块的名称。</p>
<p><img src="https://file.shenfq.com/pic/20210405173448.png" alt=""></p>
<p>然后我们安装依赖（<strong>不管是何种依赖管理的方式，安装方法依旧不变</strong>）：</p>
<pre class="language-bash"><code class="language-bash">go get github.com/TreyBastian/colourize
</code></pre>
<p><img src="https://file.shenfq.com/pic/20210405173658.png" alt=""></p>
<p><code>go.mod</code> 中，会写入添加的依赖，以及版本号，同时，该模块会被安装到 GOPATH 中。由于我们之前将 GOPATH 移除，这里会安装到 GOPATH 的默认值中（<code>~/go/</code>）。</p>
<p><img src="https://file.shenfq.com/pic/20210405173923.png" alt=""></p>
<h3 id="%E5%AF%BC%E5%85%A5%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%9C%AC%E5%9C%B0%E6%A8%A1%E5%9D%97">导入与导入本地模块<a class="anchor" href="#%E5%AF%BC%E5%85%A5%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%9C%AC%E5%9C%B0%E6%A8%A1%E5%9D%97">§</a></h3>
<p>前面介绍导入模块的方式，通过 <code>go get</code> 下载第三方模块，然后导入的方式。如果我们当前的项目中，需要进行模块的拆分，应该怎么做呢？</p>
<p>我们可以创建一个新的 <code>utils</code> 模块，在 <code>go-story</code> 目录下新建一个 <code>utils</code> 文件夹，然后新建 <code>utils.go</code> 文件。</p>
<p><img src="https://file.shenfq.com/pic/20210409162345.png" alt=""></p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> utils <span class="token comment">// 声明包名为 utils</span>

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">Log</span><span class="token punctuation">(</span>msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>然后，我们去到 <code>main.go</code> 引入该模块：</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"go-story/utils"</span>


<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	utils<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"测试第三方模块"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>我们引入模块的方式为，之前调用 <code>go mod init</code> 的时候声明的 <code>module-name</code>（<code> go-stroy</code>），然后加上模块内部声明的 <code>package-name</code>（<code>utils</code>）。</p>
<p>这里的 <code>package-name</code> 指的是代码内的 <code>package utils</code>，不是指文件名，我们可以将 <code>utils.go</code> 重命名为 <code>index.go</code>，代码也是能正常运行的。</p>
<p><img src="https://file.shenfq.com/pic/20210409163034.png" alt=""></p>
<p>可以看到 <code>utils/index.go</code> 中，没有显示的 <code>export</code> 之类的语法来进行方法的暴露。实际上，go 中只要是大写开头的方法就可以被外部调用。</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// utils/index.go</span>
<span class="token keyword">package</span> utils
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">log</span><span class="token punctuation">(</span>msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-go"><code class="language-go"><span class="token comment">// main.go</span>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">"go-story/utils"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	utils<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"测试第三方模块"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果将方法改为小写，会调用失败。</p>
<p><img src="https://file.shenfq.com/pic/20210409163419.png" alt=""></p>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>之前开发 node 的过程中，也踩过很多 npm 的坑，而且社区对 npm 也有很多怨言，也出现了很多第三方的模块：<code>yarn</code>、<code>pnpm</code> 等等。</p>
<p>想不到 go 的模块管理，也是一部血泪史，现在下载一些 go 的老项目还会发现一些 <code>go vendor</code> 管理方式的项目。另外，<code>go mod</code> 出现后，go 官方也在计划移除 <code>GOPATH</code>。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/docs/index.js"></script></body></html>