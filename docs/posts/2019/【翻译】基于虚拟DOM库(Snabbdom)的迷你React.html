<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:title" content="【翻译】基于虚拟DOM库(Snabbdom)的迷你React · 自然醒的博客"/><meta data-react-helmet="true" property="og:description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary"/>
<title data-react-helmet="true">【翻译】基于虚拟DOM库(Snabbdom)的迷你React · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/docs/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/docs/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/docs/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/docs/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/docs/">自然醒的博客</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/docs/assets/czs-close-l.svg&quot;)"></a><h1><a href="/docs/">自然醒的博客</a></h1><p class="description">前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/docs/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/docs/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/docs/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/docs/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/docs/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/docs/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/docs/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/docs/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/docs/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/docs/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/docs/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/docs/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#snabbdom%E7%AE%80%E6%98%93%E6%95%99%E7%A8%8B">snabbdom简易教程</a><ol><li><a href="#%E5%8A%A8%E6%80%81%E8%A7%86%E5%9B%BE">动态视图</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94">事件响应</a></li></ol></li><li><a href="#%E5%A4%8D%E6%9D%82%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">复杂的应用程序</a><ol><li><a href="#%E4%B8%BB%E6%B5%81%E7%A8%8B">主流程</a></li><li><a href="#elm-%E6%9E%B6%E6%9E%84elm-architecture">Elm 架构（Elm architecture）</a></li><li><a href="#%E6%A1%88%E4%BE%8B%E4%B8%80%E8%AE%A1%E6%95%B0%E5%99%A8">案例一：计数器</a></li><li><a href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%E4%B8%A4%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8">案例二：两个计数器</a></li><li><a href="#%E6%A1%88%E4%BE%8B%E4%B8%89%E8%AE%A1%E6%95%B0%E5%99%A8%E5%88%97%E8%A1%A8">案例三：计数器列表</a></li><li><a href="#%E5%9C%A8-actions-%E4%B8%AD%E4%BD%BF%E7%94%A8-union-%E7%B1%BB%E5%9E%8B">在 actions 中使用 union 类型</a></li></ol></li><li><a href="#todomvc%E4%BE%8B%E5%AD%90">TodoMVC例子</a></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ol></nav></aside><section class="main"><h1>【翻译】基于虚拟DOM库(Snabbdom)的迷你React</h1><div class="main_post_meta"><time dateTime="2019/05/01">2019-05-01</time> · <!-- -->shenfq</div><article><blockquote>
<p><a href="https://medium.com/@yelouafi/react-less-virtual-dom-with-snabbdom-functions-everywhere-53b672cb2fe3">原文链接</a></p>
</blockquote>
<blockquote>
<p>原文写于 2015-07-31，虽然时间比较久远，但是对于我们理解虚拟 DOM 和 view 层之间的关系还是有很积极的作用的。</p>
</blockquote>
<p>React 是 JavaScript 社区的新成员，尽管 JSX （在 JavaScript 中使用 HTML 语法）存在一定的争议，但是对于虚拟 DOM 人们有不一样的看法。</p>
<p>对于不熟悉的人来说，虚拟 DOM 可以描述为某个时刻真实DOM的简单表示。其思想是：每次 UI 状态发生更改时，重新创建一个虚拟 DOM，而不是直接使用命令式的语句更新真实 DOM ，底层库将对应的更新映射到真实 DOM 上。</p>
<p>需要注意的是，更新操作并没有替换整个 DOM 树（例如使用 innerHTML 重新设置 HTML 字符串），而是替换 DOM 节点中实际修改的部分（改变节点属性、添加子节点）。这里使用的是增量更新，通过比对新旧虚拟 DOM 来推断更新的部分，然后将更新的部分通过补丁的方式更新到真实 DOM 中。</p>
<p>虚拟 DOM 因为高效的性能经常受到特别的关注。但是还有一项同样重要的特性，虚拟 DOM 可以把 UI 表示为状态函数的映射（PS. 也就是我们常说的 <code>UI = render(state)</code>），这也使得编写 web 应用有了新的形式。</p>
<p>在本文中，我们将研究虚拟 DOM 的概念如何引用到 web 应用中。我们将从简单的例子开始，然后给出一个架构来编写基于 Virtual DOM 的应用。</p>
<p>为此我们将选择一个独立的 JavaScript 虚拟 DOM 库，因为我们希望依赖最小化。本文中，我们将使用 snabbdom(<a href="https://github.com/snabbdom/snabbdom">paldepind/snabbdom</a>)，但是你也可以使用其他类似的库，比如 Matt Esch 的 <a href="https://github.com/Matt-Esch/virtual-dom">virtual-dom</a></p>
<h2 id="snabbdom%E7%AE%80%E6%98%93%E6%95%99%E7%A8%8B">snabbdom简易教程<a class="anchor" href="#snabbdom%E7%AE%80%E6%98%93%E6%95%99%E7%A8%8B">§</a></h2>
<p>snabbdom 是一个模块化的库，所以，我们需要使用一个打包工具，比如 webpack。</p>
<p>首先，让我们看看如何进行 snabbdom 的初始化。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports">snabbdom</span> <span class="token keyword module">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> snabbdom<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                 <span class="token comment">// 指定模块初始化 patch 方法</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/class'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// 切换 class </span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/props'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// 设置 DOM 元素的属性</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/style'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// 处理元素的 style ，支持动画</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'snabbdom/modules/eventlisteners'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 事件处理</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>上面的代码中，我们初始化了 snabbdom 模块并添加了一些扩展。在 snabbdom 中，切换 class、style还有 DOM 元素上的属性设置和事件绑定都是给不同模块实现的。上面的实例，只使用了默认提供的模块。</p>
<p>核心模块只暴露了一个 <code>patch</code> 方法，它由 init 方法返回。我们使用它创建初始化的 DOM，之后也会使用它来进行 DOM 的更新。</p>
<p>下面是一个 Hello World 示例：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports">h</span> <span class="token keyword module">from</span> <span class="token string">'snabbdom/h'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token operator">:</span> <span class="token punctuation">{</span>fontWeight<span class="token operator">:</span> <span class="token string">'bold'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patch</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'placeholder'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>h</code> 是一个创建虚拟 DOM 的辅助函数。我们将在文章后面介绍具体用法，现在只需要该函数的 3 个输入参数：</p>
<ol>
<li>一个 CSS 选择器（jQuery 的选择器），比如 <code>div#id.class</code>。</li>
<li>一个可选的数据对象，它包含了虚拟节点的属性（class、styles、events）。</li>
<li>一个字符串或者虚拟 DOM 的数组（用于表示该节点的children）。</li>
</ol>
<p>第一次调用的时候，patch 方法需要一个 DOM 占位符和一个初始的虚拟 DOM，然后它会根据虚拟 DOM 创建一个对应的真实 DO树。在随后的的调用中，我们为它提供新旧两个虚拟 DOM，然后它通过 diff 算法比对这两个虚拟 DOM，并找出更新的部分对真实 DOM 进行必要的修改 ，使得真实的 DOM 树为最新的虚拟 DOM 的映射。</p>
<p>为了快速上手，我在 GitHub 上创建了一个仓库，其中包含了项目的必要内容。下面让我们来克隆这个仓库（<a href="https://github.com/yelouafi/snabbdom-starter">yelouafi/snabbdom-starter</a>），然后运行 <code>npm install</code> 安装依赖。这个仓库使用 Browserify 作为打包工具，文件变更后使用 Watchify 自动重新构建，并且通过 Babel 将 ES6 的代码转成兼容性更好的 ES5。</p>
<p>下面运行如下代码：</p>
<pre class="language-autoit"><code class="language-autoit">npm run watch
</code></pre>
<p>这段代码将启动 watchify 模块，它会在 app 文件夹内，创建一个浏览器能够运行的包：<code>build.js</code> 。模块还将检测我们的 js 代码是否发生改变，如果有修改，会自动的重新构建 <code>build.js</code>。（如果你想手动构建，可以使用：<code>npm run build</code>）</p>
<p>在浏览器中打开 <code>app/index.html</code> 就能运行程序，这时候你会在屏幕上看到 “Hello World”。</p>
<p>这篇文中的所有案例都能在特定的分支上进行实现，我会在文中链接到每个分支，同时 <a href="http://README.md">README.md</a> 文件也包含了所有分支的链接。</p>
<h3 id="%E5%8A%A8%E6%80%81%E8%A7%86%E5%9B%BE">动态视图<a class="anchor" href="#%E5%8A%A8%E6%80%81%E8%A7%86%E5%9B%BE">§</a></h3>
<blockquote>
<p>本例的源代码在 <a href="https://github.com/yelouafi/snabbdom-starter/tree/dynamic-view">dynamic-view branch</a></p>
</blockquote>
<p>为了突出虚拟 DOM 动态化的优势，接下来会构建一个很简单的时钟。</p>
<p>首先修改 <code>app/js/main.js</code>：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">currentDate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token string">'Current date '</span> <span class="token operator">+</span> currentDate<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">var</span> oldVnode <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'placeholder'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>通过单独的函数 <code>view</code> 来生成虚拟 DOM，它接受一个状态（当前日期）作为输入。</p>
<p>该案例展示了虚拟 DOM 的经典使用方式，在不同的时刻构造出新的虚拟 DOM，然后将新旧虚拟 DOM 进行对比，并更新到真实 DOM 上。案例中，我们每秒都构造了一个虚拟 DOM，并用它来更新真实 DOM。</p>
<h3 id="%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94">事件响应<a class="anchor" href="#%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94">§</a></h3>
<blockquote>
<p>本例的源代码在 <a href="https://github.com/yelouafi/snabbdom-starter/tree/event-reactivity">event-reactivity branch</a></p>
</blockquote>
<p>下面的案例介绍了通过事件系统完成一个打招呼的应用程序：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> placeholder<span class="token operator">:</span> <span class="token string">'Type  your name'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> input<span class="token operator">:</span> update <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'hr'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token string">'Hello '</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">var</span> oldVnode <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'placeholder'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">view</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>在 snabbdom 中，我们使用 props 对象来设置元素的属性，props 模块会对 props 对象进行处理。类似地，我们通过 on 对象进行元素的时间绑定，eventlistener 模块会对 on 对象进行处理。</p>
<p>上面的案例中，update 函数执行了与前面案例中 setInterval 类似的事情：从传入的事件对象中提取出 input 的值，构造出一个新的虚拟 DOM，然后调用 patch ，用新的虚拟 DOM 树更新真实 DOM。</p>
<h2 id="%E5%A4%8D%E6%9D%82%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">复杂的应用程序<a class="anchor" href="#%E5%A4%8D%E6%9D%82%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F">§</a></h2>
<p>使用独立的虚拟 DOM 库的好处是，我们在构建自己的应用时，可以按照自己喜欢的方式来做。你可以使用 MVC 的设计模式，可以使用更现代化的数据流体系，比如 Flux。</p>
<p>在这篇文章中，我会介绍一种不太为人所知的架构模式，是我之前在 Elm（一种可编译成 JavaScript 的 函数式语言）中使用过的。Elm 的开发者称这种模式为 <a href="https://github.com/evancz/elm-architecture-tutorial/"> Elm Architecture</a>，它的主要优点是允许我们将整个应用编写为一组纯函数。</p>
<h3 id="%E4%B8%BB%E6%B5%81%E7%A8%8B">主流程<a class="anchor" href="#%E4%B8%BB%E6%B5%81%E7%A8%8B">§</a></h3>
<p>让我们回顾一下上个案例的主流程：</p>
<ol>
<li>通过 view 函数构造出我们初始的虚拟 DOM，在 view 函数中，给 input 输入框添加了一个 input 事件。</li>
<li>通过 patch 将虚拟 DOM 渲染到真实 DOM 中，并将 input 事件绑定到真实 DOM 上。</li>
<li>等待用户输入……</li>
<li>用户输入内容，触发 input 事件，然后调用 update 函数</li>
<li>在 update 函数中，我们更新了状态</li>
<li>我们传入了新的状态给 view 函数，并生成新的虚拟 DOM （与步骤 1 相同）</li>
<li>再次调用 patch，重复上述过程（与步骤 2 相同）</li>
</ol>
<p>上面的过程可以描述成一个循环。如果去掉实现的一些细节，我们可以建立一个抽象的函数调用序列。</p>
<p><img src="https://file.shenfq.com/FvyObN9fMncD7cMXJYfZOFQJFQ--.png" alt="主流程"></p>
<p><code>user</code> 是用户交互的抽象，我们得到的是函数调用的循环序列。注意，<code>user</code> 函数是异步的，否则这将是一个无限的死循环。</p>
<p>让我们将上述过程转换为代码：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">initState<span class="token punctuation">,</span> element<span class="token punctuation">,</span> <span class="token punctuation">{</span>view<span class="token punctuation">,</span> update<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">view</span><span class="token punctuation">(</span>initState<span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newState <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>initState<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">main</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> newVnode<span class="token punctuation">,</span> <span class="token punctuation">{</span>view<span class="token punctuation">,</span> update<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>main</code> 函数反映了上述的循环过程：给定一个初始状态（initState），一个 DOM 节点和一个<em>顶层组件</em>（view + update），<code>main</code> 通过当前的状态经过 view 函数构建出新的虚拟 DOM，然后通过补丁的方式更新到真实 DOM上。</p>
<p>传递给 <code>view</code> 函数的参数有两个：首先是<em>当前</em>状态，其次是事件处理的回调函数，对生成的视图中触发的事件进行处理。回调函数主要负责为应用程序构建一个新的状态，并使用新的状态重启 UI 循环。</p>
<p>新状态的构造委托给顶层组件的 <code>update</code> 函数，该函数是一个简单的纯函数：无论何时，给定当前状态和当前程序的输入（事件或行为），它都会为程序返回一个新的状态。</p>
<p>要注意的是，除了 patch 方法会有副作用，主函数内不会有任何改变状态行为发生。</p>
<p>main 函数有点类似于低级GUI框架的 <code>main</code> 事件循环，这里的重点是收回对 UI 事件分发流程的控制: 在实际状态下，DOM API通过采用观察者模式强制我们进行事件驱动，但是我们不想在这里使用观察者模式，下面就会讲到。</p>
<h3 id="elm-%E6%9E%B6%E6%9E%84elm-architecture">Elm 架构（Elm architecture）<a class="anchor" href="#elm-%E6%9E%B6%E6%9E%84elm-architecture">§</a></h3>
<p><img src="https://file.shenfq.com/Fs8usRuYQCOKL621r-fRyMsr9ZcI.png" alt="Elm architecture"></p>
<p>基于 Elm-architecture 的程序中，是由一个个模块或者说组件构成的。每个组件都有两个基本函数：<code>update</code>和<code>view</code>，以及一个特定的数据结构：组件拥有的 <code>model</code> 以及更新该 <code>model</code> 实例的 <code>actions</code>。</p>
<ol>
<li><code>update</code> 是一个纯函数，接受两个参数：组件拥有的 <code>model</code> 实例，表示当前的状态（state），以及一个 <code>action</code> 表示需要执行的更新操作。它将返回一个新的 <code>model</code> 实例。</li>
<li><code>view</code> 同样接受两个参数：当前 <code>model</code> 实例和一个事件通道，它可以通过多种形式传播数据，在我们的案例中，将使用一个简单的回调函数。该函数返回一个新的虚拟 DOM，该虚拟 DOM 将会渲染成真实 DOM。</li>
</ol>
<p>如上所述，Elm architecture 摆脱了传统的由事件进行驱动观察者模式。相反该架构倾向于集中式的管理数据（比如 React/Flux），任何的事件行为都会有两种方式：</p>
<ol>
<li>冒泡到顶层组件；</li>
<li>通过组件树的形式进行下发，在此阶段，每个组件都可以选择自己的处理方式，或者转发给其他一个或所有子组件。</li>
</ol>
<p>该架构的另一个关键点，就是将程序需要的整个状态都保存在一个对象中。树中的每个组件都负责将它们拥有的状态的一部分传递给子组件。</p>
<p>在我们的案例中，我们将使用与 Elm 网站相同的案例，因为它完美的展示了该模式。</p>
<h3 id="%E6%A1%88%E4%BE%8B%E4%B8%80%E8%AE%A1%E6%95%B0%E5%99%A8">案例一：计数器<a class="anchor" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%E8%AE%A1%E6%95%B0%E5%99%A8">§</a></h3>
<blockquote>
<p>本例的源代码在 <a href="https://github.com/yelouafi/snabbdom-starter/tree/counter-1">counter-1 branch</a></p>
</blockquote>
<p>我们在 “counter.js” 中定义了 counter 组件：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">INC</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'inc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DEC</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'dec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// model : Number</span>
<span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">count<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">INC</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">DEC</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Count : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">count<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span>  action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">INC</span> <span class="token operator">?</span> count <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token operator">:</span> action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">DEC</span> <span class="token operator">?</span> count <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token operator">:</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> update<span class="token punctuation">,</span> actions <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">INC</span><span class="token punctuation">,</span> <span class="token constant">DEC</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<p>counter 组件由以下属性组成：</p>
<ol>
<li>Model： 一个简单的 <code>Number</code></li>
<li>View：为用户提供两个按钮，用户递增、递减计数器，以及显示当前数字</li>
<li>Update：接受两个动作：INC / DEC，增加或减少计数器的值</li>
</ol>
<p>首先要注意的是，view/update 都是纯函数，除了输入之外，他们不依赖任何外部环境。计数器组件本身不包括任何状态或变量，它只会从给定的状态构造出固定的视图，以及通过给定的状态更新视图。由于其纯粹性，计数器组件可以轻松的插入任何提供依赖（state 和 action）环境。</p>
<p>其次需要注意 <code>handler.bind(null, action)</code> 表达式，每次点击按钮，事件监听器都会触发该函数。我们将原始的用户事件转换为一个有意义的操作（递增或递减），使用了 ES6 的 Symbol 类型，比原始的字符串类型更好（避免了操作名称冲突的问题），稍后我们还将看到更好的解决方案：使用 union 类型。</p>
<p>下面看看如何进行组件的测试，我们使用了 “tape” 测试库：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports">test</span> <span class="token keyword module">from</span> <span class="token string">'tape'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> update<span class="token punctuation">,</span> actions <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../app/js/counter'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'counter update function'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">assert</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    
  <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  count <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> actions<span class="token punctuation">.</span><span class="token constant">INC</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  count <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> actions<span class="token punctuation">.</span><span class="token constant">DEC</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  assert<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>我们可以直接使用 babel-node 来进行测试</p>
<pre class="language-autoit"><code class="language-autoit">babel<span class="token operator">-</span>node test<span class="token operator">/</span>counterTest<span class="token punctuation">.</span>js
</code></pre>
<h3 id="%E6%A1%88%E4%BE%8B%E4%BA%8C%E4%B8%A4%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8">案例二：两个计数器<a class="anchor" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%E4%B8%A4%E4%B8%AA%E8%AE%A1%E6%95%B0%E5%99%A8">§</a></h3>
<blockquote>
<p>本例的源代码在 <a href="https://github.com/yelouafi/snabbdom-starter/tree/counter-2">counter-2 branch</a></p>
</blockquote>
<p>我们将和 Elm 官方教程保持同步，增加计数器的数量，现在我们会有2个计数器。此外，还有一个“重置”按钮，将两个计数器同时重置为“0”;</p>
<p>首先，我们需要修改计数器组件，让该组件支持重置操作。为此，我们将引入一个新函数 <code>init</code>，其作用是为计数器构造一个新状态 (count)。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>init</code> 在很多情况下都非常有用。例如，使用来自服务器或本地存储的数据初始化状态。它通过 JavaScript 对象创建一个丰富的数据模型(例如，为一个 JavaScript 对象添加一些原型属性或方法)。</p>
<p><code>init</code> 与 <code>update</code> 有一些区别：后者执行一个更新操作，然后从一个状态派生出新的状态；但是前者是使用一些输入值（比如：默认值、服务器数据等等）构造一个状态，输入值是可选的，而且完全不管前一个状态是什么。</p>
<p>下面我们将通过一些代码管理两个计数器，我们在 <code>towCounters.js</code> 中实现我们的代码。</p>
<p>首先，我们需要定义模型相关的操作类型：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">//{ first : counter.model, second : counter.model }</span>

<span class="token keyword">const</span> <span class="token constant">RESET</span>         <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'reset'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">UPDATE_FIRST</span>  <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'update first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">UPDATE_SECOND</span> <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'update second'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>该模型导出两个属性：first 和 second 分别保存两个计数器的状态。我们定义了三个操作类型：第一个用来将计数器重置为 0，另外两个后面也会讲到。</p>
<p>组件通过 init 方法创建 state。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> first<span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> second<span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>view 函数负责展示这两个计数器，并为用户提供一个重置按钮。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">RESET</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Reset'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'hr'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    counter<span class="token punctuation">.</span><span class="token method function property-access">view</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token property-access">first</span><span class="token punctuation">,</span> <span class="token parameter">counterAction</span> <span class="token arrow operator">=></span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">UPDATE_FIRST</span><span class="token punctuation">,</span> data<span class="token operator">:</span> counterAction<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'hr'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    counter<span class="token punctuation">.</span><span class="token method function property-access">view</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token property-access">second</span><span class="token punctuation">,</span> <span class="token parameter">counterAction</span> <span class="token arrow operator">=></span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">UPDATE_SECOND</span><span class="token punctuation">,</span> data<span class="token operator">:</span> counterAction<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<p>我们给 view 方法传递了两个参数：</p>
<ol>
<li>每个视图都会获得父组件的部分状态（model.first / model.second）</li>
<li>动态处理函数，它会传递到每个子节点的 view 。比如：第一个计数器触发了一个动作，我们会将 <code>UPDATE_FIRST</code> 封装在 action 中，当父类的 update 方法被调用时，我们会将计数器需要的 action（存储在 data 属性中）转发到正确的计数器，并调用计数器的 update 方法。</li>
</ol>
<p>下面看看 update 函数的实现，并导出组件的所有属性。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span>  action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">RESET</span>     <span class="token operator">?</span>
            <span class="token punctuation">{</span> 
              first <span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              second<span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            
        <span class="token operator">:</span> action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">UPDATE_FIRST</span>   <span class="token operator">?</span>
            <span class="token punctuation">{</span><span class="token spread operator">...</span>model<span class="token punctuation">,</span> first <span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token property-access">first</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            
        <span class="token operator">:</span> action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">UPDATE_SECOND</span>  <span class="token operator">?</span>
            <span class="token punctuation">{</span><span class="token spread operator">...</span>model<span class="token punctuation">,</span> second <span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token property-access">second</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            
        <span class="token operator">:</span> model<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> init<span class="token punctuation">,</span> update<span class="token punctuation">,</span> actions <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">UPDATE_FIRST</span><span class="token punctuation">,</span> <span class="token constant">UPDATE_SECOND</span><span class="token punctuation">,</span> <span class="token constant">RESET</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<p>update 函数处理3个操作:</p>
<ol>
<li><code>RESET</code> 操作会调用 init 将每个计数器重置到默认状态。</li>
<li><code>UPDATE_FIRST</code> 和 <code>UPDATE_SECOND</code>，会封装一个计数器需要 action。函数将封装好的 action 连同其 state 转发给相关的子计数器。</li>
</ol>
<p><code>{...model, prop: val};</code> 是 ES7 的对象扩展属性（如object .assign），它总是返回一个新的对象。我们不修改参数中传递的 state ，而是始终返回一个相同属性的新 state 对象，确保更新函数是一个纯函数。</p>
<p>最后调用 main 方法，构造顶层组件：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">main</span><span class="token punctuation">(</span>
  twoCounters<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// the initial state </span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'placeholder'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  twoCounters
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>“towCounters” 展示了经典的嵌套组件的使用模式：</p>
<ol>
<li>组件通过类似于树的层次结构进行组织。</li>
<li>main 函数调用顶层组件的 view 方法，并将全局的初始状态和处理回调（main handler）作为参数。</li>
<li>在视图渲染的时候，父组件调用子组件的 view 函数，并将子组件相关的 state 传给子组件。</li>
<li>视图将用户事件转化为对程序更有意义的 actions。</li>
<li>从子组件触发的操作会通过父组件向上传递，直到顶层组件。与 DOM 事件的冒泡不同，父组件不会在此阶段进行操作，它能做的就是将相关信息添加到 action 中。</li>
<li>在冒泡阶段，父组件的 view 函数可以拦截子组件的 actions ，并扩展一些必要的数据。</li>
<li>该操作最终在主处理程序（main handler）中结束，主处理程序将通过调用顶部组件的 update 函数进行派发操作。</li>
<li>每个父组件的 update 函数负责将操作分派给其子组件的 update 函数。通常使用在冒泡阶段添加了相关信息的 action。</li>
</ol>
<h3 id="%E6%A1%88%E4%BE%8B%E4%B8%89%E8%AE%A1%E6%95%B0%E5%99%A8%E5%88%97%E8%A1%A8">案例三：计数器列表<a class="anchor" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%E8%AE%A1%E6%95%B0%E5%99%A8%E5%88%97%E8%A1%A8">§</a></h3>
<blockquote>
<p>本例的源代码在 <a href="https://github.com/yelouafi/snabbdom-starter/tree/counter-3">counter-3 branch</a></p>
</blockquote>
<p>让我们继续来看 Elm 的教程，我们将进一步扩展我们的示例，可以管理任意数量的计数器列表。此外还提供新增计数器和删除计数器的按钮。</p>
<p>“counter” 组件代码保持不变，我们将定义一个新组件 <code>counterList</code> 来管理计数器数组。</p>
<p>我们先来定义模型，和一组关联操作。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">/*
model : {
  counters: [{id: Number, counter: counter.model}],
  nextID  : Number
}
*/</span>

<span class="token keyword">const</span> <span class="token constant">ADD</span>     <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">UPDATE</span>  <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'update counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REMOVE</span>  <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'remove'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">RESET</span>   <span class="token operator">=</span> <span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token string">'reset'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>组件的模型包括了两个参数：</p>
<ol>
<li>一个由对象（id，counter）组成的列表，id 属性与前面实例的 first 和 second 属性作用类似；它将标识每个计数器的唯一性。</li>
<li><code>nextID</code> 用来维护一个做自动递增的基数，每个新添加的计数器都会使用 <code>nextID + 1</code> 来作为它的 ID。</li>
</ol>
<p>接下来，我们定义 <code>init</code> 方法，它将构造一个默认的 state。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span>  <span class="token punctuation">{</span> nextID<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> counters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>下面定义一个 view 函数。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">ADD</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">RESET</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Reset'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'hr'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.counter-list'</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span><span class="token property-access">counters</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token arrow operator">=></span> <span class="token function">counterItemView</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<p>视图提供了两个按钮来触发“添加”和“重置”操作。每个计数器的都通过 <code>counterItemView</code> 函数来生成虚拟 DOM。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">counterItemView</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.counter-item'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>key<span class="token operator">:</span> item<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button.remove'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> id<span class="token operator">:</span> item<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Remove'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    counter<span class="token punctuation">.</span><span class="token method function property-access">view</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token property-access">counter</span><span class="token punctuation">,</span> <span class="token parameter">a</span> <span class="token arrow operator">=></span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">UPDATE</span><span class="token punctuation">,</span> id<span class="token operator">:</span> item<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">,</span> data<span class="token operator">:</span> a<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'hr'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>该函数添加了一个 remove 按钮在视图中，并引用了计数器的 id 添加到 remove 的 action 中。</p>
<p>接下来看看 update 函数。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> resetAction <span class="token operator">=</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token property-access">actions</span><span class="token punctuation">.</span><span class="token constant">INIT</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token keyword control-flow">return</span>  action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">ADD</span>     <span class="token operator">?</span> <span class="token function">addCounter</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
        <span class="token operator">:</span> action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">RESET</span>   <span class="token operator">?</span> <span class="token function">resetCounters</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
        <span class="token operator">:</span> action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">REMOVE</span>  <span class="token operator">?</span> <span class="token function">removeCounter</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> action<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token constant">UPDATE</span>  <span class="token operator">?</span> <span class="token function">updateCounter</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span> 
        <span class="token operator">:</span> model<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span> view<span class="token punctuation">,</span> update<span class="token punctuation">,</span> actions <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">ADD</span><span class="token punctuation">,</span> <span class="token constant">RESET</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> <span class="token constant">UPDATE</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<p>该代码遵循上一个示例的相同的模式，使用冒泡阶段存储的 id 信息，将子节点的 actions 转发到顶层组件。下面是 update 的一个分支 “updateCounter” 。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">updateCounter</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> id<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span><span class="token spread operator">...</span>model<span class="token punctuation">,</span>
    counters  <span class="token operator">:</span> model<span class="token punctuation">.</span><span class="token property-access">counters</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token arrow operator">=></span> 
      item<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">!==</span> id <span class="token operator">?</span> 
          item
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>item<span class="token punctuation">,</span> 
            counter <span class="token operator">:</span> counter<span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token property-access">counter</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上面这种模式可以应用于任何树结构嵌套的组件结构中，通过这种模式，我们让整个应用程序的结构进行了统一。</p>
<h3 id="%E5%9C%A8-actions-%E4%B8%AD%E4%BD%BF%E7%94%A8-union-%E7%B1%BB%E5%9E%8B">在 actions 中使用 union 类型<a class="anchor" href="#%E5%9C%A8-actions-%E4%B8%AD%E4%BD%BF%E7%94%A8-union-%E7%B1%BB%E5%9E%8B">§</a></h3>
<p>在前面的示例中，我们使用 ES6 的 Symbols 类型来表示操作类型。在视图内部，我们创建了带有操作类型和附加信息（id，子节点的 action）的对象。</p>
<p>在真实的场景中，我们必须将 action 的创建逻辑移动到一个单独的工厂函数中（类似于React/Flux中的 Action Creators）。在这篇文章的剩余部分，我将提出一个更符合 FP 精神的替代方案：union 类型。它是 FP 语言（如Haskell）中使用的 <a href="https://en.wikipedia.org/wiki/Algebraic_data_type">代数数据类型</a> 的子集，您可以将它们看作具有更强大功能的枚举。</p>
<p>union类型可以为我们提供以下特性：</p>
<ol>
<li>定义一个可描述所有可能的 actions 的类型。</li>
<li>为每个可能的值提供一个工厂函数。</li>
<li>提供一个可控的流来处理所有可能的变量。</li>
</ol>
<p>union 类型在 JavaScript 中不是原生的，但是我们可以使用一个库来模拟它。在我们的示例中，我们使用 union-type (<a href="https://github.com/paldepind/union-type">github/union-type</a>) ，这是 snabbdom 作者编写的一个小而美的库。</p>
<p>先让我们安装这个库：</p>
<pre class="language-autoit"><code class="language-autoit">npm install <span class="token operator">-</span><span class="token operator">-</span>save union<span class="token operator">-</span>type
</code></pre>
<p>下面我们来定义计数器的 actions：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Type</span></span> <span class="token keyword module">from</span> <span class="token string">'union-type'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Action</span> <span class="token operator">=</span> <span class="token function"><span class="token maybe-class-name">Type</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token maybe-class-name">Increment</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Decrement</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>Type</code> 是该库导出的唯一函数。我们使用它来定义 union 类型 <code>Action</code>，其中包含两个可能的 actions。</p>
<p>返回的 <code>Action</code> 具有一组工厂函数，用于创建所有可能的操作。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">count<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword control-flow">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Increment</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      on   <span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> handler<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Decrement</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Count : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<p>在 view 创建递增和递减两种 action。update 函数展示了 uinon 如何对不同类型的 action 进行模式匹配。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">count<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span>  <span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token method function property-access">case</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function"><span class="token maybe-class-name">Increment</span></span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function"><span class="token maybe-class-name">Decrement</span></span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> count <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>Action</code> 具有一个 <code>case</code> 方法，该方法接受两个参数：</p>
<ul>
<li>一个对象（变量名和一个回调函数）</li>
<li>要匹配的值</li>
</ul>
<p>然后，case方法将提供的 action 与所有指定的变量名相匹配，并调用相应的处理函数。返回值是匹配的回调函数的返回值。</p>
<p>类似地，我们看看如何定义 <code>counterList</code> 的 actions</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token maybe-class-name">Action</span> <span class="token operator">=</span> <span class="token function"><span class="token maybe-class-name">Type</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token maybe-class-name">Add</span>     <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Remove</span>  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Number</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Reset</span>   <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Update</span>  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Number</span><span class="token punctuation">,</span> counter<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Action</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>Add</code>和<code>Reset</code>是空数组(即它们没有任何字段)，<code>Remove</code>只有一个字段（计数器的 id）。最后，<code>Update</code> 操作有两个字段：计数器的 id 和计数器触发时的 action。</p>
<p>与之前一样，我们在 update 函数中进行模式匹配。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token method function property-access">case</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function"><span class="token maybe-class-name">Add</span></span>     <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">addCounter</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function"><span class="token maybe-class-name">Remove</span></span>  <span class="token operator">:</span> <span class="token parameter">id</span> <span class="token arrow operator">=></span> <span class="token function">removeCounter</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function"><span class="token maybe-class-name">Reset</span></span>   <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">resetCounters</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function-variable function"><span class="token maybe-class-name">Update</span></span>  <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">updateCounter</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> id<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意，<code>Remove</code> 和 <code>Update</code> 都会接受参数。如果匹配成功，<code>case</code> 方法将从 case 实例中提取字段并将它们传递给对应的回调函数。</p>
<p>所以典型的模式是：</p>
<ul>
<li>将 actions 建模为union类型。</li>
<li>在 view 函数中，使用 union 类型提供的工厂函数创建 action （如果创建的逻辑更复杂，还可以将操作创建委托给单独的函数）。</li>
<li>在 update 函数中，使用 <code>case</code> 方法来匹配 union 类型的可能值。</li>
</ul>
<h2 id="todomvc%E4%BE%8B%E5%AD%90">TodoMVC例子<a class="anchor" href="#todomvc%E4%BE%8B%E5%AD%90">§</a></h2>
<p>在这个仓库中(<a href="https://github.com/yelouafi/snabbdom-todomvc">github/yelouafi/snabbdom-todomvc</a>)，使用本文提到的规范进行了 todoMVC 应用的实现。应用程序由2个模块组成：</p>
<ul>
<li><code>task.js</code> 定义一个呈现单个任务并更新其状态的组件</li>
<li><code>todos.js</code>，它管理任务列表以及过滤和更新</li>
</ul>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>我们已经了解了如何使用小而美的虚 拟DOM 库编写应用程序。当我们不想被迫选择使用React框架（尤其是 class），或者当我们需要一个小型 JavaScript 库时，这将非常有用。</p>
<p><em>Elm architecture</em> 提供了一个简单的模式来编写复杂的虚拟DOM应用，具有纯函数的所有优点。这为我们的代码提供了一个简单而规范的结构。使用标准的模式使得应用程序更容易维护，特别是在成员频繁更改的团队中。新成员可以快速掌握代码的总体架构。</p>
<p>由于完全用纯函数实现的，我确信只要组件代码遵守其约定，更改组件就不会产生不良的副作用。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/docs/index.js"></script></body></html>