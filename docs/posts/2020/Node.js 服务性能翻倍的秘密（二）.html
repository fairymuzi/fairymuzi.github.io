<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:title" content="Node.js 服务性能翻倍的秘密（二） · 自然醒的博客"/><meta data-react-helmet="true" property="og:description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary"/>
<title data-react-helmet="true">Node.js 服务性能翻倍的秘密（二） · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">自然醒的博客</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">自然醒的博客</a></h1><p class="description">前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%89%8D%E8%A8%80">前言</a></li><li><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">如何使用</a></li><li><a href="#radix-tree">Radix Tree</a><ol><li><a href="#%E6%8F%92%E5%85%A5%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9">插入路由节点</a></li><li><a href="#%E6%9F%A5%E6%89%BE%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9">查找路由节点</a></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ol></nav></aside><section class="main"><h1>Node.js 服务性能翻倍的秘密（二）</h1><div class="main_post_meta"><time dateTime="2020/12/25">2020-12-25</time> · <!-- -->shenfq</div><article><h2 id="%E5%89%8D%E8%A8%80">前言<a class="anchor" href="#%E5%89%8D%E8%A8%80">§</a></h2>
<p>前一篇文章介绍了 <code>fastify</code> 通过 schema 来序列化 JSON，为 Node.js 服务提升性能的方法。今天的文章会介绍 <code>fastify</code> 使用的路由库，翻阅其源码（<code>lib/route.js</code>）可以发现，<code>fastify</code> 的路由库并不是内置的，而是使用了一个叫做 <code>find-my-way</code> 的路由库。</p>
<p><img src="https://file.shenfq.com/pic/20201218150431.png" alt="route.js"></p>
<p>这个路由库的简介也很有意思，号称“超级无敌快”的 HTTP 路由。</p>
<p><img src="https://file.shenfq.com/pic/20201221145756.png" alt="README"></p>
<p>看上去 <code>fastify</code> 像是依赖了第三方的路由库，其实这两个库的作者是同一批人。</p>
<p><img src="https://file.shenfq.com/pic/20201221150633.png" alt="author"></p>
<h2 id="%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">如何使用<a class="anchor" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">§</a></h2>
<p><code>find-my-way</code> 通过 <code>on</code> 方法绑定路由，并且提供了 HTTP 所有方法的简写。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./index'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message": "GET /a"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/a/b'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message": "GET /a/b"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>其实内部就是通过遍历所有的 HTTP 方法名，然后在原型上扩展的。</p>
<pre class="language-js"><code class="language-js"><span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">on</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> opts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 opts 为函数，表示此时的 opts 为 handler</span>
    handler <span class="token operator">=</span> opts
    opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> http<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> m <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  <span class="token keyword">const</span> methodName <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token method function property-access">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 扩展方法简写</span>
  <span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>绑定的路由可以通过 <code>lookup</code> 调用，只要将原生的 req 和 res 传入 lookup 即可。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 只要将原生的 req 和 res 传入 lookup 即可</span>
  router<span class="token punctuation">.</span><span class="token method function property-access">lookup</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
server<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre>
<p><code>find-my-way</code> 会通过 <code>req.method</code>/<code>req.url</code> 找到对应的 handler，然后进行调用。</p>
<pre class="language-js"><code class="language-js"><span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">lookup</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">lookup</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">,</span> <span class="token function">sanitizeUrl</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>handle <span class="token operator">===</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_defaultRoute</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用 hendler</span>
  <span class="token keyword control-flow">return</span> handle<span class="token punctuation">.</span><span class="token method function property-access">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> handle<span class="token punctuation">.</span><span class="token property-access">params</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>路由的添加和查找都基于树结构来实现的，下面我们来看看具体的实现。</p>
<h2 id="radix-tree">Radix Tree<a class="anchor" href="#radix-tree">§</a></h2>
<p><code>find-my-way</code> 采用了名为 <code>Radix Tree</code>（基数树） 的算法，也被称为 <code>Prefix Tree</code>（前缀树）。Go 语言里常用的 web 框架<a href="https://github.com/labstack/echo">echo</a>和<a href="https://github.com/gin-gonic/gin">gin</a>都使用了<code>Radix Tree</code>作为路由查找的算法。</p>
<blockquote>
<p>在计算机科学中，基数树，或称压缩前缀树，是一种更节省空间的Trie（<a href="https://baike.baidu.com/item/%E5%89%8D%E7%BC%80%E6%A0%91/2501595">前缀树</a>）。对于基数树的每个节点，如果该节点是确定的子树的话，就和父节点合并。</p>
</blockquote>
<p><img src="https://file.shenfq.com/pic/20201222133828.png" alt="Radix Tree"></p>
<p>在 <code>find-my-way</code> 中每个 HTTP 方法（<code>GET</code>、<code>POST</code>、<code>PUT</code> ...）都会对应一棵前缀树。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// 方法有所简化...</span>
<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Router</span></span> <span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">trees</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">routes</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">on</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> opts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 opts 为函数，表示此时的 opts 为 handler</span>
    handler <span class="token operator">=</span> opts
    opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_on</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">_on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">on</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">routes</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> handler<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 调用 _insert 方法</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_insert</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>

<span class="token punctuation">}</span>
<span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">_insert</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_insert</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取出方法对应的 tree</span>
  <span class="token keyword">var</span> currentNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">trees</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentNode <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首次插入构造一个新的 Tree</span>
    currentNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">trees</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> currentNode
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为 currentNode 插入新的节点...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>每个方法对应的树在第一次获取不存在的时候，都会先创建一个根节点，根节点使用默认字符（<code>/</code>）。</p>
<p><img src="https://file.shenfq.com/pic/20201225154411.png" alt="trees"></p>
<p>每个节点的数据结构如下：</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// 只保留了一些重要参数，其他的暂时忽略</span>
<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Node</span></span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">prefix</span> <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">prefix</span> <span class="token operator">||</span> <span class="token string">'/'</span> <span class="token comment">// 去除公共前缀之后的字符，默认为 /</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">label</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">prefix</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>         <span class="token comment">// 用于存放其第一个字符</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">method</span> <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">method</span>        <span class="token comment">// 请求的方法</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handler</span> <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">handler</span>      <span class="token comment">// 请求的回调</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token property-access">children</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 存放后续的子节点</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当我们插入了几个路由节点后，树结构的具体构造如下：</p>
<pre class="language-js"><code class="language-js">router<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message":"hello world"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/aa'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message":"hello world"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/ab'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message":"hello world"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/20201225154625.png" alt="GET Tree"></p>
<pre class="language-js"><code class="language-js"><span class="token maybe-class-name">Node</span> <span class="token punctuation">{</span>
  label<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
  prefix<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token maybe-class-name">Node</span> <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
      prefix<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      handler<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Function</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token maybe-class-name">Node</span> <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span>
      prefix<span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      handler<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Function</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  handler<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Function</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果我们绑定一个名为 <code>/axxx</code> 的路由，为了节约内存，不会生成三个 label 为<code>x</code> 的节点，只会生成一个节点，其 label 为 <code>x</code>，prefix 为 <code>xxx</code>。</p>
<pre class="language-js"><code class="language-js">router<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message":"hello world"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/axxx'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'{"message":"hello world"}'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/20201225154501.png" alt="GET Tree"></p>
<pre class="language-js"><code class="language-js"><span class="token maybe-class-name">Node</span> <span class="token punctuation">{</span>
  label<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
  prefix<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token maybe-class-name">Node</span> <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'x'</span><span class="token punctuation">,</span>
      prefix<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      handler<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Function</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  handler<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">Function</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="%E6%8F%92%E5%85%A5%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9">插入路由节点<a class="anchor" href="#%E6%8F%92%E5%85%A5%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9">§</a></h3>
<p>通过之前的代码可以看到， <code>on</code> 方法最后会调用内部的 <code>_insert</code> 方法插入新的节点，下面看看其具体的实现方式：</p>
<pre class="language-js"><code class="language-js"><span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">_insert</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_insert</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取出方法对应的 tree</span>
  <span class="token keyword">var</span> currentNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">trees</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentNode <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首次插入构造一个新的 Tree</span>
    currentNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">trees</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> currentNode
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> len <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token keyword null nil">null</span>
  <span class="token keyword">var</span> prefix <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">var</span> prefixLen <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword control-flow">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    prefix <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token property-access">prefix</span>
    prefixLen <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token property-access">length</span>
    len <span class="token operator">=</span> prefixLen
    path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
    <span class="token comment">// 查找是否存在公共前缀</span>
    node <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token method function property-access">findByLabel</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 公共前缀存在，复用</span>
      currentNode <span class="token operator">=</span> node
      <span class="token keyword control-flow">continue</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 公共前缀不存在，创建一个</span>
    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> method<span class="token punctuation">,</span> prefix<span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span>
    currentNode<span class="token punctuation">.</span><span class="token method function property-access">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>插入节点会调用 Node 原型上的 <code>addChild</code> 方法。</p>
<pre class="language-js"><code class="language-js"><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">getLabel</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">prefix</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">addChild</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> label <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token method function property-access">getLabel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 取出第一个字符做为 label</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> node
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
</code></pre>
<p>本质是遍历路径的每个字符，然后判断当前节点的子节点是否已经存在一个节点，如果存在就继续向下遍历，如果不存在，则新建一个节点，插入到当前节点。</p>
<p><img src="https://file.shenfq.com/pic/20201225161215.gif" alt="tree"></p>
<h3 id="%E6%9F%A5%E6%89%BE%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9">查找路由节点<a class="anchor" href="#%E6%9F%A5%E6%89%BE%E8%B7%AF%E7%94%B1%E8%8A%82%E7%82%B9">§</a></h3>
<p><code>find-my-way</code> 对外提供了 <code>lookup</code> 方法，用于查找路由对应的方法并执行，内部是通过 <code>find</code> 方法查找的。</p>
<pre class="language-js"><code class="language-js"><span class="token class-name">Router</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">find</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">find</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> version</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> currentNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">trees</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentNode<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span>

  <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> pathLen <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token property-access">length</span>
    <span class="token keyword">var</span> prefix <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token property-access">prefix</span>
    <span class="token keyword">var</span> prefixLen <span class="token operator">=</span> prefix<span class="token punctuation">.</span><span class="token property-access">length</span>
    <span class="token keyword">var</span> len <span class="token operator">=</span> prefixLen
    <span class="token keyword">var</span> previousPath <span class="token operator">=</span> path
    <span class="token comment">// 找到了路由</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>pathLen <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> path <span class="token operator">===</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> handle <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token property-access">handler</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&amp;&amp;</span> handle <span class="token operator">!==</span> <span class="token keyword nil">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
          handler<span class="token operator">:</span> handle<span class="token punctuation">.</span><span class="token property-access">handler</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 继续向下查找</span>
    path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span>
    currentNode <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token method function property-access">findChild</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">findChild</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">[</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword nil">undefined</span> <span class="token operator">||</span> child<span class="token punctuation">.</span><span class="token property-access">handler</span> <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token property-access">prefix</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span> <span class="token operator">===</span> child<span class="token punctuation">.</span><span class="token property-access">prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> child
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span>
<span class="token punctuation">}</span>
</code></pre>
<p>查找节点也是通过遍历树的方式完成的，找到节点之后还需要放到 handle 是否存在，存在的话需要执行回调。</p>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>本文主要介绍了 <code>fastify</code> 的路由库通过 <a href="https://zh.wikipedia.org/zh-hans/%E5%9F%BA%E6%95%B0%E6%A0%91"><code>Radix Tree</code></a> 进行提速的思路，相比于其他的路由库通过正则匹配（例如 koa-router 就是通过 <a href="https://github.com/pillarjs/path-to-regexp">path-to-regexp</a> 来解析路径的），效率上还是高很多的。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>