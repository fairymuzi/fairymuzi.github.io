<!doctype html><html class="" data-reactroot=""><head><script src="/assets/hm.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:title" content="前端模块化的前世 · 自然醒的博客"/><meta data-react-helmet="true" property="og:description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary"/>
<title data-react-helmet="true">前端模块化的前世 · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">自然醒的博客</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">自然醒的博客</a></h1><p class="description">前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#commonjs-%E7%9A%84%E5%87%BA%E7%8E%B0">CommonJS 的出现</a></li><li><a href="#amd%E8%A7%84%E8%8C%83requirejs">AMD规范：RequireJS</a><ol><li><a href="#requirejs-%E5%8E%9F%E7%90%86">RequireJS 原理</a><ol></ol></li></ol></li><li><a href="#cmd%E8%A7%84%E8%8C%83seajs">CMD规范：sea.js</a><ol><li><a href="#seajs-%E5%8E%9F%E7%90%86">sea.js 原理</a><ol></ol></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ol></nav></aside><section class="main"><h1>前端模块化的前世</h1><div class="main_post_meta"><time dateTime="2019/10/08">2019-10-08</time> · <!-- -->shenfq</div><article><p>随着前端项目的越来越庞大，组件化的前端框架，前端路由等技术的发展，模块化已经成为现代前端工程师的一项必备技能。无论是什么语言一旦发展到一定地步，其工程化能力和可维护性势必得到相应的发展。</p>
<p>模块化这件事，无论在哪个编程领域都是相当常见的事情，模块化存在的意义就是为了增加可复用性，以尽可能少的代码是实现个性化的需求。同为前端三剑客之一的 CSS 早在 2.1 的版本就提出了 <code>@import</code> 来实现模块化，但是 JavaScript 直到 ES6 才出现官方的模块化方案： ES Module (<code>import</code>、<code>export</code>)。尽管早期 JavaScript 语言规范上不支持模块化，但这并没有阻止 JavaScript  的发展，官方没有模块化标准开发者们就开始自己创建规范，自己实现规范。</p>
<h2 id="commonjs-%E7%9A%84%E5%87%BA%E7%8E%B0">CommonJS 的出现<a class="anchor" href="#commonjs-%E7%9A%84%E5%87%BA%E7%8E%B0">§</a></h2>
<p>十年前的前端没有像现在这么火热，模块化也只是使用闭包简单的实现一个命名空间。2009 年对 JavaScript 无疑是重要的一年，新的 JavaScript 引擎 (v8) ，并且有成熟的库 (jQuery、YUI、Dojo)，ES5 也在提案中，然而 JavaScript 依然只能出现在浏览器当中。早在2007年，AppJet 就提供了一项服务，创建和托管服务端的 JavaScript 应用。后来 Aptana 也提供了一个能够在服务端运行 Javascript 的环境，叫做 Jaxer。网上还能搜到关于 AppJet、Jaxer 的博客，甚至 Jaxer 项目还在<a href="https://github.com/aptana/Jaxer">github</a>上。</p>
<p><img src="https://file.shenfq.com/20191008214141.png" alt="Jaxer"></p>
<p>但是这些东西都没有发展起来，Javascript  并不能替代传统的服务端脚本语言 (PHP、Python、Ruby) 。尽管它有很多的缺点，但是不妨碍有很多人使用它。后来就有人开始思考 JavaScript 要在服务端运行还需要些什么？于是在 2009 年 1 月，Mozilla 的工程师 <a href="http://www.kevindangoor.com/">Kevin Dangoor</a> 发起了 CommonJS 的提案，呼吁 JavaScript 爱好者联合起来，编写 JavaScript 运行在服务端的相关规范，一周之后，就有了 224 个参与者。</p>
<blockquote>
<p>&quot;[This] is not a technical problem,It's a matter of people getting together and making a decision to step forward and start building up something bigger and cooler together.&quot;</p>
</blockquote>
<p>CommonJS 标准囊括了 JavaScript 需要在服务端运行所必备的基础能力，比如：模块化、IO 操作、二进制字符串、进程管理、Web网关接口 (JSGI) 。但是影响最深远的还是 CommonJS 的模块化方案，CommonJS 的模块化方案是JavaScript社区第一次在模块系统上取得的成果，不仅支持依赖管理，而且还支持作用域隔离和模块标识。再后来 node.js 出世，他直接采用了 <code>CommonJS</code> 的模块化规范，同时还带来了npm (Node Package Manager，现在已经是全球最大模块仓库了) 。</p>
<p>CommonJS 在服务端表现良好，很多人就想将 CommonJS 移植到客户端 (也就是我们说的浏览器) 进行实现。由于CommonJS 的模块加载是同步的，而服务端直接从磁盘或内存中读取，耗时基本可忽略，但是在浏览器端如果还是同步加载，对用户体验极其不友好，模块加载过程中势必会向服务器请求其他模块代码，网络请求过程中会造成长时间白屏。所以从 CommonJS 中逐渐分裂出来了一些派别，在这些派别的发展过程中，出现了一些业界较为熟悉方案 AMD、CMD、打包工具（Component/Browserify/Webpack）。</p>
<h2 id="amd%E8%A7%84%E8%8C%83requirejs">AMD规范：RequireJS<a class="anchor" href="#amd%E8%A7%84%E8%8C%83requirejs">§</a></h2>
<p><img src="https://file.shenfq.com/20191008214224.png" alt="RequireJS logo"></p>
<p>RequireJS 是 AMD 规范的代表之作，它之所以能代表 AMD 规范，是因为 RequireJS 的作者 (James Burke) 就是 AMD 规范的提出者。同时作者还开发了<a href="https://github.com/jrburke/amdefine"> <code>amdefine</code></a>，一个让你在 node 中也可以使用 AMD 规范的库。</p>
<p>AMD 规范由 CommonJS 的 Modules/Transport/C 提案发展而来，毫无疑问，Modules/Transport/C 提案的发起者就是 James Burke。</p>
<p>James Burke 指出了 CommonJS 规范在浏览器上的一些不足：</p>
<ol>
<li>缺少模块封装的能力：CommonJS 规范中的每个模块都是一个文件。这意味着每个文件只有一个模块。这在服务器上是可行的，但是在浏览器中就不是很友好，浏览器中需要做到尽可能少的发起请求。</li>
<li>使用同步的方式加载依赖：虽然同步的方法进行加载可以让代码更容易理解，但是在浏览器中使用同步加载会导致长时间白屏，影响用户体验。</li>
<li>CommonJS 规范使用一个名为 <code>export</code> 的对象来暴露模块，将需要导出变量附加到 <code>export</code> 上，但是不能直接给该对象进行赋值。如果需要导出一个构造函数，则需要使用 <code>module.export</code>，这会让人感到很疑惑。</li>
</ol>
<p>AMD 规范定义了一个 <code>define</code> 全局方法用来定义和加载模块，当然 RequireJS 后期也扩展了 <code>require</code> 全局方法用来加载模块 。通过该方法解决了在浏览器使用 CommonJS 规范的不足。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">define</span><span class="token punctuation">(</span>id<span class="token operator">?</span><span class="token punctuation">,</span> dependencies<span class="token operator">?</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ol>
<li>
<p>使用匿名函数来封装模块，并通过函数返回值来定义模块，这更加符合 JavaScript 的语法，这样做既避免了对 <code>exports</code> 变量的依赖，又避免了一个文件只能暴露一个模块的问题。</p>
</li>
<li>
<p>提前列出依赖项并进行异步加载，这在浏览器中，这能让模块开箱即用。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"logger"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token method function property-access">debug</span><span class="token punctuation">(</span><span class="token string">"starting foo's definition"</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"foo"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li>
<p>为模块指定一个模块 ID (名称) 用来唯一标识定义中模块。此外，AMD的模块名规范是 CommonJS 模块名规范的超集。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'foo'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</li>
</ol>
<h3 id="requirejs-%E5%8E%9F%E7%90%86">RequireJS 原理<a class="anchor" href="#requirejs-%E5%8E%9F%E7%90%86">§</a></h3>
<p>在讨论原理之前，我们可以先看下 RequireJS 的基本使用方式。</p>
<ul>
<li>
<p>模块信息配置：</p>
<pre class="language-javascript"><code class="language-javascript">require<span class="token punctuation">.</span><span class="token method function property-access">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  paths<span class="token operator">:</span> <span class="token punctuation">{</span>
    jquery<span class="token operator">:</span> <span class="token string">'<a class="token url-link" href="https://code.jquery.com/jquery-3.4.1.js">https://code.jquery.com/jquery-3.4.1.js</a>'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li>
<p>依赖模块加载与调用：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jquery'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">$</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">html</span><span class="token punctuation">(</span><span class="token string">'loaded'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li>
<p>模块定义：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span> <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span><span class="token property-access">amd</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">define</span><span class="token punctuation">(</span> <span class="token string">"jquery"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> jQuery<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
</ul>
<p>我们首先使用 <code>config</code> 方法进行了 jquery 模块的路径配置，然后调用 <code>require</code> 方法加载 jquery 模块，之后在回调中调用已加载完成的 <code>$</code> 对象。在这个过程中，jquery 会使用 <code>define</code> 方法暴露出我们所需要的 <code>$</code> 对象。</p>
<p>在了解了基本的使用过程后，我们就继续深入 RequireJS 的原理。</p>
<h4 id="%E6%A8%A1%E5%9D%97%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE">模块信息配置<a class="anchor" href="#%E6%A8%A1%E5%9D%97%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE">§</a></h4>
<p>模块信息的配置，其实很简单，只用几行代码就能实现。定义一个全局对象，然后使用 <code>Object.assign</code> 进行对象扩展。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 配置信息</span>
<span class="token keyword">const</span> cfg <span class="token operator">=</span> <span class="token punctuation">{</span> paths<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token comment">// 全局 require 方法</span>
req <span class="token operator">=</span> <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 扩展配置</span>
req<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">config</span> <span class="token operator">=</span> <span class="token parameter">config</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="%E4%BE%9D%E8%B5%96%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E4%B8%8E%E8%B0%83%E7%94%A8">依赖模块加载与调用<a class="anchor" href="#%E4%BE%9D%E8%B5%96%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E4%B8%8E%E8%B0%83%E7%94%A8">§</a></h4>
<p><code>require</code> 方法的逻辑很简单，进行简单的参数校验后，调用 <code>getModule</code> 方法对 <code>Module</code> 进行了实例化，getModule 会对已经实例化的模块进行缓存。因为 require 方法进行模块实例的时候，并没有模块名，所以这里产生的是一个匿名模块。Module 类，我们可以理解为一个模块加载器，主要作用是进行依赖的加载，并在依赖加载完毕后，调用回调函数，同时将依赖的模块逐一作为参数回传到回调函数中。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 全局 require 方法</span>
req <span class="token operator">=</span> <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> deps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callback <span class="token operator">=</span> deps
    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  mod<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span>deps<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> reqCounter <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 已注册的模块</span>

<span class="token comment">// 模块加载器的工厂方法</span>
<span class="token keyword">const</span> <span class="token function-variable function">getModule</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果模块名不存在，表示为匿名模块，自动构造模块名</span>
    name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@mod_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">++</span>reqCounter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> mod <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mod <span class="token operator">=</span> registry<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> mod
<span class="token punctuation">}</span>
</code></pre>
<p>模块加载器是是整个模块加载的核心，主要包括 <code>enable</code> 方法和 <code>check</code> 方法。</p>
<p>模块加载器在完成实例化之后，会首先调用 <code>init</code> 方法进行初始化，初始化的时候传入模块的依赖以及回调。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 模块加载器</span>

<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depCount</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depMaps</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depExports</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">definedFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">deps</span> <span class="token operator">=</span> deps
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">callback</span> <span class="token operator">=</span> callback
    <span class="token comment">// 判断是否存在依赖</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>enable</code> 方法主要用于模块的依赖加载，该方法的主要逻辑如下：</p>
<ol>
<li>
<p>遍历所有的依赖模块；</p>
</li>
<li>
<p>记录已加载模块数 (<code>this.depCount++</code>)，该变量用于判断依赖模块是否全部加载完毕；</p>
</li>
<li>
<p>实例化依赖模块的模块加载器，并绑定 <code>definedFn</code> 方法；</p>
<blockquote>
<p><code>definedFn</code> 方法会在依赖模块加载完毕后调用，主要作用是获取依赖模块的内容，并将 <code>depCount</code> 减 1，最后调用 <code>check</code> 方法 (该方法会判断 <code>depCount</code> 是否已经小于 1，以此来界定依赖全部加载完毕)；</p>
</blockquote>
</li>
<li>
<p>最后通过依赖模块名，在配置中获取依赖模块的路径，进行模块加载。</p>
</li>
</ol>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token spread operator">...</span>
  <span class="token comment">// 启用模块，进行依赖加载</span>
  <span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历依赖</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">deps</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录已加载的模块数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depCount</span><span class="token operator">++</span>
      
      <span class="token comment">// 实例化依赖模块的模块加载器，绑定模块加载完毕的回调</span>
      <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">getModule</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      mod<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">definedFn</span> <span class="token operator">=</span> <span class="token parameter">exports</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depCount</span><span class="token operator">--</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depExports</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> exports
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// 在配置中获取依赖模块的路径，进行模块加载</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> cfg<span class="token punctuation">.</span><span class="token property-access">paths</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token function">loadModule</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>loadModule</code> 的主要作用就是通过 url 去加载一个 js 文件，并绑定一个 onload 事件。onload 会重新获取依赖模块已经实例化的模块加载器，并调用 <code>init</code> 方法。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 缓存加载的模块</span>
<span class="token keyword">const</span> defMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 依赖的加载</span>
<span class="token keyword">const</span> <span class="token function-variable function">loadModule</span> <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> head <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
  node<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">=</span> <span class="token string">'text/javascript'</span>
  node<span class="token punctuation">.</span><span class="token property-access">async</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 设置一个 data 属性，便于依赖加载完毕后拿到模块名</span>
  node<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-module'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
  node<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> onScriptLoad<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  node<span class="token punctuation">.</span><span class="token property-access">src</span> <span class="token operator">=</span> url
  head<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> node
<span class="token punctuation">}</span>

<span class="token comment">// 节点绑定的 onload 事件函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">onScriptLoad</span> <span class="token operator">=</span> <span class="token parameter">evt</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> node <span class="token operator">=</span> evt<span class="token punctuation">.</span><span class="token property-access">currentTarget</span>
  node<span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> onScriptLoad<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取模块名</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token method function property-access">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-module'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">getModule</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token keyword">const</span> def <span class="token operator">=</span> defMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  mod<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token property-access">deps</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看到之前的案例，因为只有一个依赖 (jQuery)，并且 jQuery 模块并没有其他依赖，所以 <code>init</code> 方法会直接调用 <code>check</code> 方法。这里也可以思考一下，如果是一个有依赖项的模块后续的流程是怎么样的呢？</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">define</span><span class="token punctuation">(</span> <span class="token string">"jquery"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">/* 无其他依赖 */</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> jQuery<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>check</code> 方法主要用于依赖检测，以及调用依赖加载完毕后的回调。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 模块加载器</span>
<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token spread operator">...</span>
  <span class="token comment">// 检查依赖是否加载完毕</span>
  <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">exports</span>
    <span class="token comment">//如果依赖数小于1，表示依赖已经全部加载完毕</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depCount</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token comment">// 调用回调，并获取该模块的内容</span>
      exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depExports</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> exports
      <span class="token comment">//激活 defined 回调</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">definedFn</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最终通过 <code>definedFn</code> 重新回到被依赖模块，也就是最初调用 <code>require</code> 方法实例化的匿名模块加载器中，将依赖模块暴露的内容存入 <code>depExports</code> 中，然后调用匿名模块加载器的 <code>check</code> 方法，调用回调。</p>
<pre class="language-javascript"><code class="language-javascript">mod<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">definedFn</span> <span class="token operator">=</span> <span class="token parameter">exports</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depCount</span><span class="token operator">--</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">depExports</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> exports
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89">模块定义<a class="anchor" href="#%E6%A8%A1%E5%9D%97%E5%AE%9A%E4%B9%89">§</a></h4>
<p>还有一个疑问就是，在依赖模块加载完毕的回调中，怎么拿到的依赖模块的依赖和回调呢？</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> def <span class="token operator">=</span> defMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
mod<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token property-access">deps</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token punctuation">)</span>
</code></pre>
<p>答案就是通过全局定义的 <code>define</code> 方法，该方法会将模块的依赖项还有回调存储到一个全局变量，后面只要按需获取即可。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> defMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 缓存加载的模块</span>
<span class="token function-variable function">define</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  defMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> deps<span class="token punctuation">,</span> callback <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="requirejs-%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93">RequireJS 原理总结<a class="anchor" href="#requirejs-%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93">§</a></h4>
<p>最后可以发现，RequireJS 的核心就在于模块加载器的实现，不管是通过 <code>require</code> 进行依赖加载，还是使用 <code>define</code> 定义模块，都离不开模块加载器。</p>
<p>感兴趣的可以在我的github上查看关于简化版 RequrieJS 的<a href="https://github.com/Shenfq/think-modular/blob/master/requirejs/fake/require.js">完整代码</a> 。</p>
<h2 id="cmd%E8%A7%84%E8%8C%83seajs">CMD规范：sea.js<a class="anchor" href="#cmd%E8%A7%84%E8%8C%83seajs">§</a></h2>
<p><img src="https://file.shenfq.com/20191008214223.png" alt="sea.js logo"></p>
<p>CMD 规范由国内的开发者玉伯提出，尽管在国际上的知名度远不如 AMD ，但是在国内也算和 AMD 齐头并进。相比于 AMD 的异步加载，CMD 更加倾向于懒加载，而且 CMD 的规范与 CommonJS 更贴近，只需要在 CommonJS 外增加一个函数调用的包装即可。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./b"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>作为 CMD 规范的实现 sea.js 也实现了类似于 RequireJS 的 api：</p>
<pre class="language-javascript"><code class="language-javascript">seajs<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">main</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  main<span class="token punctuation">.</span><span class="token method function property-access">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>sea.js 在模块加载的方式上与 RequireJS 一致，都是通过在 head 标签插入 script 标签进行加载的，但是在加载顺序上有一定的区别。要讲清楚这两者之间的差别，我们还是直接来看一段代码：</p>
<p><strong>RequireJS</strong> :</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// RequireJS</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'a load'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">run</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'a run'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'b load'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">run</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'b run'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'main run'</span><span class="token punctuation">)</span>
  a<span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  b<span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/20191008214225.png" alt="requirejs result"></p>
<p><strong>sea.js</strong> :</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// sea.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'a load'</span><span class="token punctuation">)</span>
  exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">run</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'a run'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'b load'</span><span class="token punctuation">)</span>
  exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">run</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'b run'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'main run'</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
  a<span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
  b<span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

seajs<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/20191008214226.png" alt="sea.js result"></p>
<p>可以看到 sea.js 的模块属于懒加载，只有在 require 的地方，才会真正运行模块。而 RequireJS，会先运行所有的依赖，得到所有依赖暴露的结果后再执行回调。</p>
<p>正是因为懒加载的机制，所以 sea.js 提供了 <code>seajs.use</code> 的方法，来运行已经定义的模块。所有 define 的回调函数都不会立即执行，而是将所有的回调函数进行缓存，只有 use 之后，以及被 require 的模块回调才会进行执行。</p>
<h3 id="seajs-%E5%8E%9F%E7%90%86">sea.js 原理<a class="anchor" href="#seajs-%E5%8E%9F%E7%90%86">§</a></h3>
<p>下面简单讲解一下 sea.js 的懒加载逻辑。在调用 define 方法的时候，只是将 模块放入到一个全局对象进行缓存。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> seajs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> cache <span class="token operator">=</span> seajs<span class="token punctuation">.</span><span class="token property-access">cache</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token function-variable function">define</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> uri <span class="token operator">=</span> <span class="token function">id2uri</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token function">parseDependencies</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> cache<span class="token punctuation">[</span>uri<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>uri<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">)</span>
  mod<span class="token punctuation">.</span><span class="token property-access">deps</span> <span class="token operator">=</span> deps
  mod<span class="token punctuation">.</span><span class="token property-access">factory</span> <span class="token operator">=</span> factory
  
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">uri<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">uri</span>    <span class="token operator">=</span> uri
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">deps</span>   <span class="token operator">=</span> deps
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里的 Module，是一个与 RequireJS 类似的模块加载器。后面运行的 seajs.use 就会从缓存取出对应的模块进行加载。</p>
<blockquote>
<p>注意：这一部分代码只是简单介绍 use 方法的逻辑，并不能直接运行。</p>
</blockquote>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">let</span> cid <span class="token operator">=</span> <span class="token number">0</span>
seajs<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">use</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ids<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">?</span> ids <span class="token operator">:</span> <span class="token punctuation">[</span>ids<span class="token punctuation">]</span>
  
  deps<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mod <span class="token operator">=</span> cache<span class="token punctuation">[</span>dep<span class="token punctuation">]</span>
    mod<span class="token punctuation">.</span><span class="token method function property-access">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>另外 sea.js 的依赖都是在 factory 中声明的，在模块被调用的时候，sea.js 会将 factory 转成字符串，然后匹配出所有的 <code>require('xxx')</code> 中的 <code>xxx</code> ，来进行依赖的存储。前面代码中的 <code>parseDependencies</code> 方法就是做这件事情的。</p>
<p>早期 sea.js 是直接通过正则的方式进行匹配的：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">parseDependencies</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">REQUIRE_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">"(?:\\"|[^"])*"|'(?:\\'|[^'])*'|\/\*[\S\s]*?\*\/|\/(?:\\\/|[^/\r\n])+\/(?=[^\/])|\/\/.*|\.\s*require|(?:^|[^$])\brequire\s*\(\s*(["'])(.+?)\1\s*\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
  <span class="token keyword">const</span> <span class="token constant">SLASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  code
    <span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token constant">SLASH_RE</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token constant">REQUIRE_RE</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> __<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> ret
<span class="token punctuation">}</span>
</code></pre>
<p>但是后来发现正则有各种各样的 bug，并且过长的正则也不利于维护，所以 sea.js 后期舍弃了这种方式，转而使用状态机进行词法分析的方式获取 require 依赖。</p>
<p>详细代码可以查看 sea.js 相关的子项目：<a href="https://github.com/seajs/crequire">crequire</a>。</p>
<h4 id="seajs-%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93">sea.js 原理总结<a class="anchor" href="#seajs-%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93">§</a></h4>
<p>其实 sea.js 的代码逻辑大体上与 RequireJS 类似，都是通过创建 script 标签进行模块加载，并且都有实现一个模块记载器，用于管理依赖。</p>
<p>主要差异在于，sea.js 的懒加载机制，并且在使用方式上，sea.js 的所有依赖都不是提前声明的，而是 sea.js 内部通过正则或词法分析的方式将依赖手动进行提取的。</p>
<p>感兴趣的可以在我的github上查看关于简化版 sea.js 的<a href="https://github.com/Shenfq/think-modular/blob/master/seajs/fake/sea.js">完整代码</a> 。</p>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>ES6 的模块化规范已经日趋完善，其静态化思想也为后来的打包工具提供了便利，并且能友好的支持 tree shaking。了解这些已经过时的模块化方案看起来似乎有些无趣，但是历史不能被遗忘，我们应该多了解这些东西出现的背景，以及前人们的解决思路，而不是一直抱怨新东西更迭的速度太快。</p>
<p>不说鸡汤了，挖个坑，敬请期待下一期的《前端模块化的今生》。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>